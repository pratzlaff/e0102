#! /bin/bash

#
# Adapted from
#
# ./plot_shiftfits
#

set -eo pipefail

[ $# -eq 1 ] || {
    echo Usage: $0 gainfits_table
    exit
}

f="$1"

[ -z "$CONTAMID" ] && {
    echo "CONTAMID is not set, exiting" 1>&2
    exit 1
}

chip=${DET^^}
emin=0.35
emax=1.6

SCRIPTDIR=$( cd -- "$( dirname -- "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )
. "$SCRIPTDIR/functions.sh"

. ~/.bash_aliases
shopt -s expand_aliases

heainit

plot_gainfit() {
    [ $# -eq 5 ] || {
	echo "Usage: $0 obsid cstat dof redchi chi" 1>&2
	return 1
    }
    local obsid="$1"
    local cstat="$2"
    local dof="$3"
    local redchi="$4"
    local chi="$5"

    obsid=$(printf %05d $((10#"$obsid")))
    fitdir="$datadir/fits/$CONTAMID/$obsid"
    savefile="$fitdir/${obsid}_gainfit.save"
    plotfile="$fitdir/${obsid}_gainfit_plot.xcm"
    psfile="$fitdir/${obsid}_gainfit.ps"

    cd $fitdir

    cat - <<EOP >"$plotfile"
@$savefile
setplot energy
setplot xlog off
iplot data resid
rescale x $emin $emax
label otop CONTAMID=$CONTAMID, gain fits
label top $chip, ObsID $obsid, C-stat=$cstat, dof=$dof, Q-stat=$chi, reduced Q stat=$redchi
hardcopy $psfile/cps
EOP
    xspec < "$plotfile"
    cd -
}

while IFS= read -r line; do
    [[ "$line" =~ ^# ]] && continue
    read -r obsid cstat dof redchi chi <<<$(perl -anle 'print join " ", @F[0, 10..13]' <<< "$line")
    plot_gainfit $obsid $cstat $dof $redchi $chi
done < "$f"
