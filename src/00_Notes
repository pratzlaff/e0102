# see
#  /data/paul11/plucinsk/chandra/data/e0102/I3/99999/repro_ciao4.15.1_caldb4.10.4/contamN0015_cstat_shift_en_test_ciao4.15.1_caldbs4.10.4_combine_fit.xcm
#  /data/paul11/plucinsk/chandra/data/e0102/I3/99999/repro_ciao4.15.1_caldb4.10.4/combine_spectra.com

set -eo pipefail

. ./functions.sh

. ~/.bash_aliases
shopt -s expand_aliases

ciao

export CONTAMID=$(./ciaostr)

# add obsids to ../obsids/all.lst, then
export DET=all
./download
./repro
false && {
    cp -a ../data/obsids/all.lst ../data/obsids/all.lst.bak
    ./rewrite_obsid_lst all
    ./obs_info | tee $datadir/obs_info/$det.txt
    # make new bkg regions
}
./images

false && {
    for det in i3 s3 all; do
	DET=$det ./obs_info | tee $datadir/obs_info/$det.txt
    done
}

export CONTAMID=$(./ciaostr)
export RESP120C=
export FITMG=

time for det in i3 s3; do
    export DET=$det
    obsids=$(obsids $det)

    resdir="$datadir/fits/$CONTAMID/results"
    mkdir -p "$resdir"

    ./obs_info | tee $datadir/obs_info/$det.txt

    false && ./specextract

    ./gainfit
    gainfits_txt="$resdir/gainfits_${DET}.txt"
    perl ./compile_fit_results.pl gain $obsids | tee "$gainfits_txt"
    ./plot_gainfits "$gainfits_txt"
    psmerge_xspec gain

    echo '.run shift_lines.pro'  | gdl -args $obsids

    ./linefit
    linefits_txt="$resdir/linefits_${DET}.txt"
    perl ./compile_fit_results.pl line $obsids | tee "$linefits_txt"
    ./plot_linefits "$linefits_txt"
    psmerge_xspec line

    echo '.run data_shift.pro'  | gdl -args $datadir/obs_info/$DET.txt
    psmerge_gain_corrections

    ./shift_pi

    ./shiftfit
    shiftfits_txt="$resdir/shiftfits_${DET}.txt"
    perl ./compile_fit_results.pl shift $obsids | tee "$shiftfits_txt"
    ./plot_shiftfits "$shiftfits_txt"
    psmerge_xspec shift

    true && python3 \
	./plot_fit_results.py \
	/data/legs/rpete/data/e0102/obs_info/$DET.txt \
	"$shiftfits_txt" \
        -p "$resdir/params_${DET}.pdf"

done
