# see
#  /data/paul11/plucinsk/chandra/data/e0102/I3/99999/repro_ciao4.15.1_caldb4.10.4/contamN0015_cstat_shift_en_test_ciao4.15.1_caldbs4.10.4_combine_fit.xcm
#  /data/paul11/plucinsk/chandra/data/e0102/I3/99999/repro_ciao4.15.1_caldb4.10.4/combine_spectra.com

set -eo pipefail

. ./functions.sh

. ~/.bash_aliases
shopt -s expand_aliases

ciao

export CONTAMID=$(./ciaostr)

export DET=all
./download
./repro
./images

for det in i3 s3 all; do
    DET=$det ./obs_info | tee $datadir/obs_info/$det.txt
done

for det in i3 s3; do
    export DET=$det

    ./specextract

    ./gainfit $obsids
    gainfits_txt="$datadir/fits/$CONTAMID/gainfits_${DET}.txt"
    perl ./compile_gainfit_results.pl $obsids > "$gainfits_txt"
    ./plot_gainfits "$gainfits_txt"
    psmerge_xspec gain

    echo '.run shift_lines.pro'  | gdl -args $obsids

    ./linefit $obsids
    linefits_txt="$datadir/fits/$CONTAMID/linefits_${DET}.txt"
    perl ./compile_linefit_results.pl $obsids > "$linefits_txt"
    ./plot_linefits "$linefits_txt"
    psmerge_xspec line

    echo '.run data_shift.pro'  | gdl -args $datadir/obs_info/$DET.txt
    psmerge_gain_corrections

    ./shift_pi

    ./shiftfit
    shiftfits_txt="$datadir/fits/$CONTAMID/shiftfits_${DET}.txt"
    perl ./compile_shiftfit_results.pl $obsids > "$shiftfits_txt"
    ./plot_shiftfits "$shiftfits_txt"
    psmerge_xspec shift

    python3 \
	./plot_fit_results.py \
	/data/legs/rpete/data/e0102/obs_info/$DET.txt \
	"$shiftfits_txt" \
	-p "$datadir/fits/$CONTAMID/params_${DET}.pdf"

done
