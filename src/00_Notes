set -eo pipefail

. ./functions.sh

. ~/.bash_aliases
shopt -s expand_aliases

ciao

export CONTAMID=$(./ciaostr)

for det in i3 s3; do
    export DET=$det

    obsids=$(obsids $DET)

    for obsid in $obsids; do
	obsid=$((10#$obsid))
	o5str=$(printf %05d $obsid)
	[ -d "$datadir/$o5str" ] || echo ./download $obsid
	[ -d "$datadir/$o5str/repro" ] || echo ./repro $obsid
	[ -f "$datadir/images/$o5str.jpg" ] || echo ./images $obsid
    done

    mkdir -p $datadir/obs_info
    ./obs_info $obsids > $datadir/obs_info/$DET.txt

    ./specextract $obsids

    ./gainfit $obsids
    gainfits_txt="$datadir/fits/$CONTAMID/gainfits_${DET}.txt"
    perl compile_gainfit_results.pl $obsids > "$gainfits_txt"
    ./plot_gainfits "$gainfits_txt"
    psmerge_xspec gain

    echo '.run shift_lines.pro'  | gdl -args $obsids

    ./linefit $obsids
    linefits_txt="$datadir/fits/$CONTAMID/linefits_${DET}.txt"
    perl compile_linefit_results.pl $obsids > "$linefits_txt"
    ./plot_linefits "$linefits_txt"
    psmerge_xspec line

    echo '.run data_shift.pro'  | gdl -args $datadir/obs_info/$DET.txt
    psmerge_gain_corrections

    ./shift_pi $obsids

    ./shiftfit $obsids
    shiftfits_txt="$datadir/fits/$CONTAMID/shiftfits_${DET}.txt"
    perl ./compile_shiftfit_results.pl $obsids > "$shiftfits_txt"
    ./plot_shiftfits "$shiftfits_txt"
    psmerge_xspec shift

    python3 \
	./plot_fit_results.py \
	/data/legs/rpete/data/e0102/obs_info/$DET.txt \
	"$shiftfits_txt"

done


