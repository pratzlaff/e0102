set -eo pipefail

. ./functions.sh

. ~/.bash_aliases
shopt -s expand_aliases

ciao

export CONTAMID=$(./ciaostr)

for det in i3 s3; do
    export DET=$det

    obsids=$(obsids $DET)

    for obsid in $obsids; do
	obsid=$((10#$obsid))
	o5str=$(printf %05d $obsid)
	[ -d "$datadir/$o5str" ] || echo ./download $obsid
	[ -d "$datadir/$o5str/repro" ] || echo ./repro $obsid
	[ -f "$datadir/images/$o5str.jpg" ] || echo ./images $obsid
    done

    mkdir -p $datadir/obs_info
    ./obs_info $obsids > $datadir/obs_info/$DET.txt

    ./specextract $obsids

    ./gainfit $obsids

done
exit


./specextract $obsids

./gainfit $obsids

perl compile_gainfit_results.pl $obsids > $datadir/fits/$CONTAMID/gainfits_${DET}.txt

echo '.run shift_lines.pro'  | gdl -args $obsids

./linefit $obsids

perl compile_linefit_results.pl $obsids > $datadir/fits/$CONTAMID/linefits_${DET}.txt

echo '.run data_shift.pro'  | gdl -args $datadir/obs_info/$DET.txt

./shift_pi $obsids

./shiftfit $obsids

perl ./compile_shiftfit_results.pl $obsids > $datadir/fits/$CONTAMID/shiftfits_${DET}.txt

./plot_shiftfits $datadir/fits/$CONTAMID/shiftfits_${DET}.txt

python3 \
    ./plot_fit_results.py \
    $datadir/obs_info/$DET.txt \
    $datadir/fits/$CONTAMID/shiftfits_${DET}.txt

psfiletmp=$datadir/fits/$CONTAMID/shiftfits_${DET}.ps.tmp
psfile="${psfiletmp%%.tmp}"
for obsid in $obsids; do
    obsid=$(printf %05d $((10#$obsid)))
    echo $datadir/fits/$CONTAMID/$obsid/${obsid}_shiftfit.ps
done | xargs psmerge -o "$psfiletmp"
gs -dBATCH -dNOPAUSE -sOutputFile="$psfile" -sDEVICE=ps2write -dAutoRotatePages=/None -c "<< /Orientation 3 >> setpagedevice" 0 rotate 0 0 translate -f "$psfiletmp"
rm "$psfiletmp"
